---
title: "Introduction to R: Basic Functionality"
output: 
  md_document:
    variant: gfm
---

We continue from yesterday by exploring the relationship between variables, both with visualisations and statistical tests. Don't forget to turn your R scripts into the Blackboard.

***

## Part 1: Introduction to ggplot2

First, we must load in the dataset again, keeping only complete cases.

```{r}
fhs <- read.csv(url("https://raw.githubusercontent.com/molepi/Molecular-Data-Science/master/RIntro_practical/data.csv"))
fhs <- fhs[complete.cases(fhs), ]
```

We should also set our library location and load in the `tidyverse` package.

```{r eval=FALSE}
.libPaths("C:/fos_2019/library")
```
```{r warning=FALSE, message=FALSE}
library(tidyverse)
```

***

The package `ggplot2` is commonly used to produce visualisations of data. The plots will appear in the **Plots** pane, you can save them  using the Export button if you would like.

The `ggplot()` function alone just initializes a blank plot. You can specify your x and y axis using `aes()`, but no lines or points will be drawn. You can pipe your data to `ggplot()` using `%>%` or specify it as the first argument.

```{r}
fhs %>%
  ggplot(aes(BMI, GLUCOSE))
```

***

Titles can be specified by adding `ggtitle()` to the `ggplot()` function with the `+` operator. X and Y axis labels can also be implemented with `xlab()` and `ylab()`, respectively.

```{r}
fhs %>%
  ggplot(aes(BMI, GLUCOSE)) +
  ggtitle("Graph of BMI against Glucose levels") +
  xlab("BMI (kg/m^2)") +
  ylab("Glucose level (mg/dL")
```

***

In order to add data visualisation to our graph, we need to add `geom` elements. One of these, `geom_bar()` is used to create bar charts for categorical variables.

The `aes()` function can be moved inside the `geom_bar()`, which is useful if you want to overlap multiple `geom` elements showcasing different aspects of your data.

Additionally, `alpha`, `colour`, and `fill` options can specify the appearance of the bars. Note, you can spell colour either the American or English way - both are accepted as arguments. Changing these options can be done for other `geom` elements as well.

```{r}
fhs %>%
  ggplot() +
  geom_bar(aes(EDUC), alpha=0.7, colour='grey30', fill='cadetblue2') +
  ggtitle("Bar plot of Education levels") + 
  xlab("Education level") 
```

***

Bars can be coloured by other variables to see the distribution of one category within another. This is done by moving the `fill` option inside the `aes()` function and specifying a categorical variable.

```{r}
fhs %>%
  ggplot() +
  geom_bar(aes(EDUC, fill=SEX), alpha=0.7, color='grey30') +
  ggtitle("Bar plot of sex within Education levels") + 
  xlab("Education level") 
```

***

Subsetting, as shown yesterday with `dplyr` can also be piped into `ggplot()`. We can show the above graph only for those who experienced MI, for example.

```{r}
fhs %>%
  filter(MI == 'Yes') %>%
  ggplot() +
  geom_bar(aes(EDUC, fill=SEX), alpha=0.7, color='grey30') +
  ggtitle("Bar plot of sex within Education levels") + 
  xlab("Education level") 
```

***

To view bars side-by-side instead of stacked, set `position` to `dodge`.

```{r}
fhs %>%
  filter(MI == 'Yes') %>%
  ggplot() +
  geom_bar(aes(EDUC, fill=SEX), alpha=0.7, color='grey30', position="dodge") +
  ggtitle("Bar plot of sex within Education levels") + 
  xlab("Education level") 
```

***

For continuous variables, we divide the x axis into bins and visualize using `geom_histogram()`. 

```{r}
fhs %>%
  ggplot() +
  geom_histogram(aes(AGE), binwidth=2, alpha=0.7, colour='grey30', fill='cadetblue3') +
  ggtitle("Histogram of age distribution") +
  xlab("Age (years)")
```

***

To show the distribution of a continuous variable within categories, you can use `facet_wrap()` which takes a `formula` class as an argument. Separating plots by group using `facet_wrap()` is possible for most `ggplot` graphics.

```{r}
fhs %>%
  ggplot() +
  geom_histogram(aes(AGE), binwidth=2, alpha=0.7, colour='grey30', fill='cadetblue3') +
  facet_wrap(~EDUC) +
  ggtitle("Histogram of age distribution within education levels") +
  xlab("Age (years)")
```

***

In order to show a smoothed version of a histogram, a density plot, we use `geom_density`. 

```{r}
fhs %>%
  ggplot() +
  geom_density(aes(SYSBP), alpha=0.7, colour='grey30', fill='cadetblue2') +
  ggtitle("Density plot of systolic blood pressure") +
  xlab("Systolic BP (mmHg)")
```

***

If you want to look at a variable's distribution between groups, use the `fill` option within `aes()`.

```{r}
fhs %>%
  ggplot() +
  geom_density(aes(SYSBP, fill=BPMEDS), alpha=0.7, colour='grey30') +
  ggtitle("Density plot of systolic blood pressure within BP medication status") +
  xlab("Systolic BP (mmHg)")
```

***

This will show the distributions separately, but you can also stack them with a `position` argument.

```{r}
fhs %>%
  ggplot() +
  geom_density(aes(SYSBP, fill=BPMEDS), alpha=0.7, colour='grey30', position="stack") +
  ggtitle("Density plot of systolic blood pressure within BP medication status") +
  xlab("Systolic BP (mmHg)")
```

***

#### Question 1: Make the following:

* A bar plot of MI, coloured by smoking status
* A histogram of total cholesterol in overweight individuals
* Four density plots of age for each education level
* Two bar plots of sex in current and non-smokers for those who experienced MI

***

## Part 2: Comparative Plots

A scatter plot can be a good way to compare two continuous variables. In `ggplot` this is implemented using `geom_point()`.  

```{r}
fhs %>%
  ggplot() +
  geom_point(aes(SYSBP, DIABP), alpha=0.7) +
  ggtitle("Scatter plot of Systolic BP against Diastolic BP") +
  xlab("Systolic BP (mmHg)") +
  ylab("Diastolic BP (mmHg)")
```

***

Reference lines can be added to plots using `geom_vline()`, `geom_hline()`, and `geom_abline()`. These are very useful for annotating plots.

```{r}
fhs %>%
  ggplot() +
  geom_point(aes(SYSBP, DIABP), alpha=0.7) +
  geom_vline(aes(xintercept=160), color='red', size=1.5, alpha=0.7) +
  ggtitle("Scatter plot of Systolic BP against Diastolic BP") +
  xlab("Systolic BP (mmHg)") +
  ylab("Diastolic BP (mmHg)")
```

***

You can also use the `cut()` function alongside `seq()` to create categorical variables, to help with visualisations.


```{r}
fhs %>%
  ggplot() +
  geom_point(aes(SYSBP, DIABP), alpha=0.7) +
  geom_vline(aes(xintercept=160), color='red', size=1.5, alpha=0.7) +
  ggtitle("Scatter plot of Systolic BP against Diastolic BP") +
  xlab("Systolic BP (mmHg)") +
  ylab("Diastolic BP (mmHg)") +
  facet_wrap(. ~ cut(AGE,seq(30,70,10)))
```

***

To show the distribution of a continuous variable across categories, you can use `geom_boxplot()`. This visualizes the median, upper and lower quartiles, and two whiskers, which extend to 1.5 IQRs. All outlying points are shown individually. 

```{r}
fhs %>%
  ggplot() +
  geom_boxplot(aes(CURSMOKE, BMI), color='grey30', fill='cadetblue2') +
  ggtitle("Distribution of BMI within smoking status") +
  xlab("Current smoking status") +
  ylab("BMI (kg/m^2)")
```

***

If you want to view a horizontal boxplot, you can use `coord_fip()`. Outliers can also be highlighted by changing their colour and shape.

```{r}
fhs %>%
  ggplot() +
  geom_boxplot(aes(CURSMOKE, BMI), color='grey30', fill='cadetblue2', outlier.color='palegreen3', outlier.shape=1) + 
  coord_flip() +
  ggtitle("Distribution of BMI within smoking status") +
  xlab("Current smoking status") +
  ylab("BMI (kg/m^2)")
```

***

Finally, box plots can also be split by a further category using the `fill` or `color` options within `aes()`.

```{r}
fhs %>%
  ggplot() +
  geom_boxplot(aes(CURSMOKE, BMI, fill=SEX), color='grey30', outlier.color='palegreen3', outlier.shape=1) + 
  coord_flip() +
  ggtitle("Distribution of BMI within smoking status") +
  xlab("Current smoking status") +
  ylab("BMI (kg/m^2)")
```

***

#### Question 2: Make the following:

* A scatter plot of glucose levels against BMI, coloured by diabetes status.
* A horizontal box plot of systolic BP by sex for people over the age of 60
* A scatter plot of total cholesterol against glucose for categories of BMI

***

## Part 3: Statistical Tests

Next we will perform some statistical tests. Sometimes, it can be helpful to save tables so that they can be used in other functions.

```{r}
SMOKE_MI <- xtabs(~CURSMOKE+MI, fhs)
SMOKE_MI
```

***

Then, we can use this table in a chi-square test, to see if there is a significant association between smoking status and MI.

```{r}
chisq <- chisq.test(SMOKE_MI)
chisq
```

In this instance, we have sufficient evidence (X2=9.73, p=0.002) that smoking and MI are significantly associated. Pearson residuals can be inspected to explore which groups are contributing to this evidence.

```{r}
round(chisq$residuals, 3)
```

***

Visualizations can often inform future statistical investigations. Perhaps, the scatter plot above suggested a positive correlation between systolic and diastolic blood pressure, but we want to investigate this further.

We can use `cor.test` to test if the correlation between two variables is significant.

```{r}
cor <- cor.test(~ SYSBP + DIABP, fhs) 
cor
```

This shows that we have significant evidence from our data that systolic and diastolic blood pressure are strongly correlated (r=0.79, p<0.001). 

***

The box plot shown above might suggest that older individuals are more likely to have experienced MI. We can formally test this using a t-test.

```{r}
tt <- t.test(AGE ~ MI, fhs) 
tt
```

This test concludes that we have sufficient evidence to suggest a significant difference in age between those who had and did not have MI (t=-9.03, p<0.001).

***

To run logistic regression in R, you use the `glm()` function, specifying the `family` as binomial. So explore the fit, use the `summary()` function.

```{r}
glmfit <- glm(MI ~ BMI + AGE + SEX, fhs, family = "binomial") 
summary(glmfit)
```

This returns the estimate, standard errors, z-score, and p-values for each of the coefficients. Here, we have strong evidence (p<0.001) that higher BMI is associated with an increased risk of MI, after adjusting for age and sex. 

To calculate the OR, we take the exponent of the coefficients.

```{r}
exp(coef(glmfit))
```

Here, we can see that the odds of MI for males is 3.3 times higher than for females, after adjusting for BMI and age.

***

#### Question 3:

* Is age correlated with total cholesterol?
* Is MI associated with glucose levels?
* Is MI associated with glucose levels in individuals with diabetes?

***

## Part 4: Loops 

One of the advantages of using R is to use loops to perform multiple analyses at once. As an example, the following loop calculates the association of MI with all the other variables and stores them in a data frame. 

```{r}
results <- data.frame()       
for (i in colnames(fhs)[-ncol(fhs)]) {  
  fit <- glm(MI ~ get(i), fhs, family = "binomial") 
  results <- rbind(results, summary(fit)$coefficients[2, , drop = FALSE]) 
}
rownames(results) <- colnames(fhs)[-ncol(fhs)] 
results$OR <- exp(results$Estimate) 
results[order(results$"Pr(>|z|)"), ] 
```

This is quite a complicated loop, but we can dissect the different parts to get an idea of what loops in R consist of.

***

An `if` statement is only run if the condition is true.

```{r}
if (1 < 2) { 
  print("1 is smaller than 2") 
}
```

***

An `else` statement is only run if the condition of the if-statement is false.

```{r}
if (1 > 2) {
  print("1 is greater than 2")
} else {
  print("1 is not greater than 2")
}
```

***

With `for` loops you assign a range of values to a variable and perform the actions in the loop for all these values in order.

```{r}
for (i in 1:10) { # loop over values 1 to 10
  if (i < 5) {
    print(paste(i, "is smaller than 5"))
  } else {
    print(paste(i, "is not smaller than 5"))
  }
}
```

***

You can also utilise loops and make your own functions in R.

```{r}
greater <- function(x, y) { 
  if (x > y) {
    paste(x, "is greater than", y)
  } else {
    paste(x, "is not greater than", y)
  }
}
greater(1, 2)
greater(2, 1)
```

***

```{r}
greater <- function(x, y, z) { 
  paste(x*y*z)
}
greater(1, 2, 3)
greater(2, 1, 4)
```

#### Question 6:

* Make a function that requires as arguments x, y and z and returns their product.
* Make a loop that returns the association of all columns of data frame fhs with age.

***

You have just written your own simple function, but hopefully you can see how complicated they could become. You can do so many things in R, and new functions are being written all the time, but if a function to do something doesn't exist, you can always try to create your own.

See you after lunch!

***